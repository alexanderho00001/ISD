# Survival Analysis Visualization Methods Documentation

This document explains the insights and interpretations behind all four visualization types in the predictor detail page.

---

## Data Sources Overview

All visualizations draw from model artifacts generated during training and stored in `media/models/<model_id>/`. Understanding these files is key to interpreting the visualizations.

### survival_curves.json

**What it contains**: Individual predicted survival curves for each subject in the test set.

**Structure**:
```json
{
  "quantile_levels": [0.0, 0.091, 0.182, ...],
  "survival_probabilities": [100.0, 90.9, 81.8, ...],
  "curves": {
    "0": {
      "times": [0, 31.59, 76.75, 98.22, ...],
      "survival_probabilities": [100, 90.91, 81.82, 72.73, ...]
    },
    "1": { ... },
    ...
  }
}
```

**What it means**: For each subject (identified by their test index), the model has generated a complete survival trajectory showing their predicted probability of survival at multiple time points. The `quantile_levels` and top-level `survival_probabilities` represent the overall population-level Kaplan-Meier estimate.

**Used by**: Individual Predictions visualization

---

### full_predictions.json

**What it contains**: Comprehensive prediction data and actual outcomes for all test subjects.

**Structure**:
```json
{
  "test_indices": [0, 1, 2, 3, ...],
  "actual_times": [3.0, 243.0, 711.0, ...],
  "actual_events": [1, 1, 1, 0, ...],
  "median_predictions": [270.0, 546.1, 494.3, ...],
  "mean_predictions": [486.4, 781.2, 733.1, ...],
  "prob_at_actual_time": [0.0, 18.18, 54.55, ...],
  "quantile_levels": [0.0, 0.091, 0.182, ...],
  "quantile_predictions": [[...], [...], ...]
}
```

**What it means**:
- **test_indices**: Subject identifiers (row numbers from the dataset)
- **actual_times**: Observed survival or censoring times (ground truth)
- **actual_events**: Whether the event occurred (1) or patient was censored (0)
- **median_predictions**: Model's predicted median survival time for each subject
- **mean_predictions**: Model's predicted mean survival time for each subject
- **prob_at_actual_time**: Model's predicted probability (0-100%) that the event would occur by each subject's observed time
- **quantile_levels**: Probability thresholds used for predictions
- **quantile_predictions**: Predicted times at each quantile level for each subject

**Used by**: Predicted Survival Histogram, D-Calibration Histogram, Kaplan-Meier Visualization

---

### full_predictions_summary.csv

**What it contains**: Tabular summary of predictions with additional metrics.

**Columns**:
- `identifier`: Subject ID
- `censored`: Whether subject was censored (yes/no)
- `event_time`: Observed time
- `predicted_prob_event`: Predicted probability of event
- `predicted_median_survival`: Predicted median survival time
- `predicted_mean_survival`: Predicted mean survival time
- `absolute_error`: Difference between predicted and actual (only for uncensored)

**What it means**: A human-readable table format of predictions, useful for detailed inspection and export. The `absolute_error` is only calculated for uncensored subjects since we can't measure error for censored observations.

**Used by**: Individual Predictions Table (below the survival curves chart)

---

### How These Files Relate

1. **Training Phase**: The MTLR model is trained on the training set
2. **Prediction Phase**: Model generates predictions for the test set
3. **Output Generation**: 
   - `survival_curves.json` stores the full survival trajectories
   - `full_predictions.json` stores summary statistics and actual outcomes
   - `full_predictions_summary.csv` provides a tabular view for analysis

All three files describe the same test subjects, just in different formats optimized for different purposes.

---

## 1. Individual Predictions (Survival Curves)

### What This Chart Shows

This visualization displays the model's predicted survival curves for individual subjects from the test dataset. Each curve represents one person's predicted survival probability over time, showing how likely they are to survive at any given point in the future. The chart comes from `survival_curves.json`, where the model has generated a complete survival trajectory for each subject based on their clinical features.

Think of each curve as the model's personalized survival forecast for that individual. A subject with a rapidly declining curve is predicted to have higher risk, while someone with a slowly declining curve has better predicted outcomes. The black dashed line overlaying all curves represents the average (Kaplan-Meier) survival trend across the displayed subjects.

### Data Origin

The survival curves are generated by the MTLR (Multi-Task Logistic Regression) model during training. For each subject in the test set, the model outputs survival probabilities at multiple time points (quantiles). These probabilities form a smooth curve that starts at 100% (everyone is alive at time 0) and decreases over time as the predicted risk of the event increases.

---

## 2. Predicted Survival Histogram

### What This Chart Shows

This histogram reveals how the model's predictions are distributed across all subjects in the test set. It answers the question: "What range of survival times is the model predicting, and how many patients fall into each range?" The data comes from `full_predictions.json`, specifically the `median_predictions` array, which contains the model's predicted median survival time for each subject.

Each bar represents a time range (bin), and the height shows how many subjects received predictions in that range. This gives you an immediate sense of whether the model is making conservative predictions (clustering around shorter times), optimistic predictions (clustering around longer times), or a balanced spread across the spectrum.

### Data Origin

During model training and evaluation, the MTLR model generates a full survival curve for each subject. From this curve, we extract the median survival time—the point at which the subject has a 50% probability of survival. These median values across all test subjects form the distribution shown in the histogram.

---

## 3. D-Calibration Histogram

### What This Chart Shows

This visualization assesses whether the model's predicted probabilities match reality—a concept called **calibration**. It answers: "When the model says a patient has a 60% chance of an event, do 60% of such patients actually experience the event?" The data comes from `full_predictions.json`, using `prob_at_actual_time` (the model's predicted probability of the event occurring by each patient's observed time) and `actual_events` (whether the event actually occurred or the patient was censored).

The horizontal bars are organized by predicted probability ranges (0-10%, 10-20%, etc.). Each bar's length shows what percentage of all subjects fell into that probability range. The bar is split into two colors: blue for patients who experienced the event (uncensored) and red for those who didn't (censored). A well-calibrated model will show mostly blue in high-probability bins and mostly red in low-probability bins.

### Data Origin

For each subject, the model generates a survival curve. At the subject's actual observed time (whether they experienced the event or were censored), we extract the model's predicted probability of the event having occurred by that point. This creates a probability value between 0-100% for each subject. We then compare these predictions to what actually happened.

---

## 4. Kaplan-Meier Visualization

### What This Chart Shows

This is the ultimate validation of your model's clinical utility. It answers: "Do patients the model predicts as high-risk actually have worse survival than those predicted as low-risk?" The visualization takes the model's predictions from `full_predictions.json` and uses them to divide patients into risk groups (typically quartiles). Then, using the actual observed survival data (`actual_times` and `actual_events`), it plots true Kaplan-Meier survival curves for each group.

The chart consists of three components: (1) Kaplan-Meier curves showing actual survival for each risk group, (2) a log-rank test matrix quantifying differences between groups, and (3) a histogram showing how predicted survival times are distributed. Together, these validate whether the model's risk stratification is meaningful in the real world.

### Data Origin

The model generates predicted survival times (median or mean) for each subject. We sort all subjects by these predictions and split them into groups—for example, with 4 groups (quartiles), Group 1 contains the 25% of patients with the shortest predicted survival (highest risk), while Group 4 contains the 25% with the longest predicted survival (lowest risk). We then calculate actual Kaplan-Meier survival curves for each group using their real-world outcomes.

---

## Summary: How These Visualizations Work Together

These four visualizations tell a complete story about your survival prediction model:

1. **Individual Curves** show what the model predicts for each person—the raw, personalized forecasts
2. **Predicted Histogram** reveals the model's overall behavior—is it making diverse, reasonable predictions?
3. **D-Calibration** tests whether the model's confidence matches reality—when it says 70%, does it mean 70%?
4. **Kaplan-Meier** validates clinical utility—do the predictions actually separate high-risk from low-risk patients?

### The Complete Picture

| Visualization | Question Answered | Data Source | What Success Looks Like |
|--------------|-------------------|-------------|------------------------|
| **Individual Curves** | "What does the model predict for each patient?" | `survival_curves.json` | Clear heterogeneity, smooth curves, logical trajectories |
| **Predicted Histogram** | "What's the range and distribution of predictions?" | `median_predictions` | Reasonable spread, no extreme outliers, matches disease patterns |
| **D-Calibration** | "Are the model's probabilities accurate?" | `prob_at_actual_time` + `actual_events` | Gradient from red to blue, high p-value (>0.05) |
| **Kaplan-Meier** | "Do predictions translate to real survival differences?" | `actual_times` + `actual_events` + predictions | Separated curves, significant log-rank tests, proper ordering |

---

## Technical Notes

### Data Pipeline
All visualizations draw from model artifacts generated during training:
- `survival_curves.json`: Individual survival trajectories
- `full_predictions.json`: Comprehensive predictions and outcomes of all identifier in the dataset predicted by the model
- Both files located in `media/models/<model_id>/`

### Implementation
- **Frontend**: React with Recharts for visualization
- **Backend**: Django REST API serving JSON files
- **Calculations**: Client-side using JavaScript for interactivity

### Statistical Methods
- **Kaplan-Meier estimator**: Non-parametric survival curve calculation
- **Log-rank test**: Comparing survival distributions between groups
- **Hosmer-Lemeshow test**: Assessing calibration quality
- **Linear interpolation**: Smoothing individual survival curves

---
